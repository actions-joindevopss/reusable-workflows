name: common-ci-cd
on: 
  workflow_call:
    inputs:
      project:
        required: true
        type: string
      component:
        required: true
        type: string
      app_type:
        required: true
        type: string
      environment:
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      SECURITY_GH_TOKEN:
        required: true
env:
  ACC_ID: ${{ vars.AWS_ACCOUNT_ID }}
jobs:
  ci: # job-name
    runs-on: self-hosted
    outputs:
      APP_VERSION: ${{ steps.package-version.outputs.APP_VERSION }}
    steps:
    - name: checkout Code
      uses: actions/checkout@v4
    - name: check the files
      run: ls -l
    - name: print inputs
      run: echo "Project is ${{ inputs.project }}"
    - name: Get app version
      id: package-version
      run: |
        APP_VERSION=$(jq -r '.version' package.json)

        # For other steps in the SAME job
        echo "APP_VERSION=$APP_VERSION" >> "$GITHUB_ENV"

        # For other JOBS in the workflow
        echo "APP_VERSION=$APP_VERSION" >> "$GITHUB_OUTPUT"
    - name: print app version
      run: echo ${APP_VERSION}
    - name: install dependencies
      run: npm install
    - name: docker build
      id: docker_build
      run: |
        docker build -t ${ACC_ID}.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}:${APP_VERSION} .
        docker images
    - name: Set BUILD status
      if: always()
      uses: actions-joindevopss/reusable-workflows/.github/actions/set-commit-status@main
      with:
        context: "DOCKER_BUILD"
        outcome: "${{ steps.docker_build.outcome }}"
        description: "DOCKER_BUILD"
    - name: Security Gate (block on open HIGH/CRITICAL)
      id: security_gate
      continue-on-error: true
      env:
        GH_TOKEN: ${{ secrets.SECURITY_GH_TOKEN }}
        GH_API: https://api.github.com
        OWNER: ${{ github.repository_owner }}
        REPO: ${{ github.event.repository.name }}
      run: |
        set -euo pipefail

        echo "Checking Dependabot alerts..."
        dep=$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
                    -H "Accept: application/vnd.github+json" \
                    "${GH_API}/repos/${OWNER}/${REPO}/dependabot/alerts?state=open&per_page=100")

        dep_count=$(echo "$dep" | jq '[.[] | select(.security_advisory.severity=="high" or .security_advisory.severity=="critical")] | length')
        echo "Open HIGH/CRITICAL Dependabot alerts: ${dep_count}"

        echo "Checking Code Scanning alerts..."
        csa=$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
                    -H "Accept: application/vnd.github+json" \
                    "${GH_API}/repos/${OWNER}/${REPO}/code-scanning/alerts?state=open&per_page=100")

        # Code scanning uses "severity": critical/high/medium/low
        csa_count=$(echo "$csa" | jq '[.[] | select(.rule.security_severity_level=="high" or .rule.security_severity_level=="critical")] | length')
        echo "Open HIGH/CRITICAL Code Scanning alerts: ${csa_count}"

        total=$((dep_count + csa_count))
        if [ "$total" -gt 0 ]; then
          echo "❌ Blocking pipeline due to open HIGH/CRITICAL security alerts"
          exit 1
        fi

        echo "✅ No open HIGH/CRITICAL alerts"

    - name: Set SECURITY_GATE status
      if: always()
      uses: actions-joindevopss/reusable-workflows/.github/actions/set-commit-status@main
      with:
        context: "SECURITY_GATE"
        outcome: "${{ steps.security_gate.outcome }}"

    - name: Stop if security gate failed
      if: ${{ steps.security_gate.outcome != 'success' }}
      run: exit 1


    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1 # Replace with your desired AWS region

  # cd:
  #   needs: ci
  #   runs-on: self-hosted
  #   steps:
  #   - name: Use version from CI job
  #     run: |
  #       echo "Deploying version: ${{ needs.ci.outputs.APP_VERSION }}"